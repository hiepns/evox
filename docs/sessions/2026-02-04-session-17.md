# Session 17 — Feb 4, 2026

## Người thực hiện
- Human: Son
- Agent: Claude (với SAM, LEO, QUINN, MAX running parallel)

## Mục tiêu
**North Star: 100% Automation** — Agents tự tìm việc, execute, commit, deploy mà không cần human intervention.

## Đã hoàn thành

| # | Task | Ticket | Status |
|---|------|--------|--------|
| 1 | Fix dashboard redirect `/live` | — | ✅ Done |
| 2 | Agents chạy bằng subscription (không tốn API) | — | ✅ Done |
| 3 | Fix Convex deploy error ("use node" issue) | — | ✅ Done |
| 4 | Split engine.ts → queries + mutations | — | ✅ Done |
| 5 | Split taskSplitting.ts → queries + mutations | — | ✅ Done |
| 6 | Deploy Convex thành công | — | ✅ Done |
| 7 | Push Vercel | — | ✅ Done |
| 8 | Tạo NORTHSTAR.md | — | ✅ Done |
| 9 | Disable SAM (đang dùng API) | — | ✅ Done |

## Files đã thay đổi

```
convex/execution/engine.ts        — Chỉ còn actions (removed queries/mutations)
convex/execution/queries.ts       — NEW: queries tách ra
convex/execution/mutations.ts     — NEW: mutations tách ra
convex/taskSplitting.ts           — Chỉ còn actions
convex/taskSplittingQueries.ts    — NEW: queries tách ra
convex/taskSplittingMutations.ts  — NEW: mutations tách ra
docs/NORTHSTAR.md                 — NEW: automation progress tracker
app/page.tsx                      — Removed demo mode redirect
```

## Bài học (QUAN TRỌNG)

1. **Convex "use node"** — File có directive `"use node"` chỉ được chứa **actions**. Queries và mutations phải tách ra file riêng KHÔNG có `"use node"`.

2. **Subscription vs API** — Claude CLI cần **TTY** (terminal) để dùng subscription credits. Headless/background process sẽ fallback về API (tốn tiền). Dùng `tmux` + `script` để giữ TTY.

3. **Agent auto-restart** — `agent-loop.sh` tự restart agent khi crash. Muốn stop hoàn toàn phải kill cả script, không chỉ kill claude process.

4. **Linear GraphQL** — Không có `orderBy: priority` trong issues query. Query theo `updatedAt` hoặc `createdAt` thay thế.

## Lỗi gặp phải & Cách fix

| Lỗi | Nguyên nhân | Fix |
|-----|-------------|-----|
| Convex deploy: "Only actions can be defined in Node.js" | File `"use node"` chứa mutation/query | Tách mutations/queries ra file riêng |
| Dashboard redirect to `/live` | Code redirect trong `page.tsx` | Xóa code redirect |
| SAM dùng API thay vì subscription | Process chạy không có TTY | Dùng tmux + script để preserve TTY |
| Agent respawn sau khi kill | `agent-loop.sh` auto-restart | Kill cả agent-loop.sh process |

## Automation Progress

```
█████████░ 90%

Đã xong:
✅ Agent self-start
✅ Agent find tickets (Linear polling)
✅ Agent claim tickets
✅ Agent execute code
✅ Agent commit & push
✅ Agent update Linear
✅ Auto-test on PR (GitHub Action)
✅ Auto-deploy (Vercel)
✅ 24/7 Operation (tmux)

Còn lại:
❌ AGT-265: Sub-agent spawning
⚠️ AGT-263: Error recovery (exponential backoff)
```

## Còn lại / Ngày mai

- [ ] AGT-265 — Sub-agent spawning for parallel work
- [ ] AGT-263 — Exponential backoff for resilience
- [ ] AGT-264 — Real-time activity dashboard

## Commands hữu ích

```bash
# Chạy agents (subscription mode)
./scripts/agent-loop.sh leo
./scripts/agent-loop.sh quinn
./scripts/agent-loop.sh max

# Chạy tất cả với tmux
./scripts/start-all-agents.sh
tmux attach -t evox

# Check processes đang chạy
ps aux | grep claude | grep -v grep

# Kill agent + loop
pkill -f "agent-loop.*sam"

# Deploy Convex
npx convex deploy --yes

# Check Linear tickets
curl -s -X POST https://api.linear.app/graphql \
  -H "Authorization: $LINEAR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": "{ issues(first: 5) { nodes { identifier title } } }"}'
```

## Notes

- LEO, QUINN, MAX đang chạy subscription (free)
- SAM disabled vì dùng API (tốn tiền)
- Vercel Pro đã mua để tránh deploy limit
