# ADR-006: Headless Agent Authentication via API Key

**Status:** Implemented
**Date:** 2026-02-04
**Context:** AGT-258

## Problem

Agents running in headless/background mode (nohup, systemd, daemon) received "Credit balance too low" errors because:
- Claude Code subscription credits require an interactive terminal (TTY)
- Headless processes don't have TTY → no subscription auth
- True headless operation impossible with subscription alone

This blocked 100% automation goal.

## Solution

Use **API key authentication** (`ANTHROPIC_API_KEY`) for headless operation:
- Claude Code automatically uses API key when `ANTHROPIC_API_KEY` is set
- API key works in any environment (TTY or no TTY)
- Combine with `tmux` for process management and log capture

## Implementation

Use `tmux` sessions for process management + API key for auth:

```bash
# Create tmux session
tmux new-session -d -s evox -n sam

# Pass ANTHROPIC_API_KEY into tmux environment
tmux set-environment -t evox ANTHROPIC_API_KEY "$ANTHROPIC_API_KEY"

# Agent runs in tmux window with API key auth
tmux send-keys -t evox:sam "./scripts/agent-loop.sh sam" Enter
```

Benefits:
- ✅ True headless operation (API key, not TTY-dependent)
- ✅ Process management via tmux (detached, multiplexed)
- ✅ Log capture via `script` command
- ✅ Can attach to view live output
- ✅ Survives terminal close
- ✅ Works everywhere (no TTY required)

## Configuration

**File:** `.env.local`

```bash
ANTHROPIC_API_KEY=sk-ant-api03-...
LINEAR_API_KEY=lin_api_...
CONVEX_DEPLOYMENT=dev:...
```

**File:** `scripts/start-all-agents.sh`

1. Load `.env.local` environment variables
2. Create detached tmux session: `tmux new-session -d -s evox`
3. Pass API key to tmux: `tmux set-environment -t evox ANTHROPIC_API_KEY "$ANTHROPIC_API_KEY"`
4. Start agent in tmux window: `tmux send-keys -t evox:sam "script -q -a logs/sam.log ./scripts/agent-loop.sh sam" Enter`
5. Logs captured to `logs/<agent>.log` via `script` command
6. Claude Code detects `ANTHROPIC_API_KEY` → uses API credits

## Usage

```bash
# Start all agents (runs in background with subscription)
./scripts/start-all-agents.sh

# View live agent output
tmux attach -t evox

# Switch between agents
tmux select-window -t evox:0  # SAM
tmux select-window -t evox:1  # LEO
tmux select-window -t evox:2  # MAX
tmux select-window -t evox:3  # QUINN

# View logs
tail -f logs/sam.log

# Stop all
./scripts/stop-all-agents.sh
```

## Alternatives Considered

1. **Subscription + TTY workaround** - Use tmux to provide TTY for subscription auth. Rejected: API key is cleaner and works everywhere.
2. **screen** - Similar to tmux but less flexible. Rejected: tmux is more powerful.
3. **systemd with pty** - Complex pseudo-TTY allocation. Rejected: tmux is simpler.
4. **nohup/daemon without tmux** - No log capture or process management. Rejected: tmux provides better UX.

## Trade-offs

**Pro:**
- True headless operation (API key works everywhere)
- Simple implementation (1 extra line to pass API key)
- Works with existing agent-loop.sh
- Easy monitoring (tmux attach + log files)
- Persists across terminal sessions
- No TTY dependency

**Con:**
- Requires API credits (cost: ~$20-50/month for all agents)
- Requires tmux installed (`brew install tmux`)
- Need to secure ANTHROPIC_API_KEY in environment

**Cost Analysis:**
- 4 agents × ~30 tasks/day × ~$0.10/task = ~$120/month
- Acceptable cost for 100% automation

## Decision

Use API key authentication (`ANTHROPIC_API_KEY`) for headless agents, with tmux for process management and log capture.

## Verification

```bash
# 1. Ensure ANTHROPIC_API_KEY is set
grep ANTHROPIC_API_KEY .env.local

# 2. Start agents
./scripts/start-all-agents.sh

# 3. Verify running in tmux
tmux list-sessions
tmux list-windows -t evox

# 4. Check logs show no auth errors
tail -f logs/sam.log | grep -i "credit\|auth"

# 5. Verify agents are picking up work
tail -f logs/sam.log | grep "TASK:"

# 6. Confirm API key is being used (not subscription)
tmux show-environment -t evox | grep ANTHROPIC_API_KEY
```

## Related

- **AGT-258**: Original blocker issue (resolved by this ADR)
- **ADR-004**: Scheduler-driven agent activation (uses this tmux approach)
- `scripts/start-all-agents.sh`: Implementation
- `scripts/agent-loop.sh`: Agent execution loop (runs in tmux)
