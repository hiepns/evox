# ADR-006: Headless Agent Authentication via tmux

**Status:** Implemented
**Date:** 2026-02-04
**Context:** AGT-258

## Problem

Agents running in headless/background mode (nohup, systemd, daemon) received "Credit balance too low" errors because:
- Claude Code subscription credits require an interactive terminal (TTY)
- Headless processes don't have TTY → no subscription auth
- API credits would cost $20-50/month per agent

This blocked 100% automation goal.

## Von Neumann Insight

> "Subscription requires TTY. tmux provides TTY."

The constraint isn't "interactive vs. headless" — it's TTY vs. no TTY.
- tmux creates pseudo-TTY for each session
- Agents run in tmux windows → have real TTY
- Claude Code detects TTY → allows subscription auth
- Result: Headless automation with subscription credits

## Solution

Use `tmux` sessions to provide TTY for each agent:

```bash
# Create tmux session (provides TTY)
tmux new-session -d -s evox -n sam

# Agent runs in tmux window with TTY
tmux send-keys -t evox:sam "./scripts/agent-loop.sh sam" Enter
```

Benefits:
- ✅ Agents run in background (detached tmux)
- ✅ Use subscription credits (TTY present)
- ✅ No API credits needed
- ✅ Multiplexed: 4 agents in 1 session
- ✅ Can attach to view live output
- ✅ Survives terminal close

## Implementation

**File:** `scripts/start-all-agents.sh`

1. Create detached tmux session: `tmux new-session -d -s evox`
2. Start agent in tmux window: `tmux send-keys -t evox:sam "script -q -a logs/sam.log ./scripts/agent-loop.sh sam" Enter`
3. Logs captured to `logs/<agent>.log` via `script` command
4. Agents have TTY → subscription auth works

**Commit:** `5543ca6` - "chore: Update agent startup to use tmux for subscription credits"

## Usage

```bash
# Start all agents (runs in background with subscription)
./scripts/start-all-agents.sh

# View live agent output
tmux attach -t evox

# Switch between agents
tmux select-window -t evox:0  # SAM
tmux select-window -t evox:1  # LEO
tmux select-window -t evox:2  # MAX
tmux select-window -t evox:3  # QUINN

# View logs
tail -f logs/sam.log

# Stop all
./scripts/stop-all-agents.sh
```

## Alternatives Considered

1. **API Credits** - Cost: $20-50/month per agent × 4 = $80-200/month. Rejected: unnecessary cost.
2. **screen** - Similar to tmux but less flexible. Rejected: tmux is more powerful.
3. **systemd with pty** - Complex pseudo-TTY allocation. Rejected: tmux is simpler.
4. **expect/script without tmux** - Fragile TTY emulation. Rejected: tmux is battle-tested.

## Trade-offs

**Pro:**
- Zero additional cost (uses existing subscription)
- Simple implementation (6 lines per agent)
- Works with existing agent-loop.sh
- Easy monitoring (tmux attach)
- Persists across terminal sessions

**Con:**
- Requires tmux installed (`brew install tmux`)
- Slight overhead (minimal, tmux is lightweight)
- Need to learn tmux basics (widely known tool)

## Decision

Use tmux to provide TTY for headless agents, enabling subscription authentication without API credits.

## Verification

```bash
# Start agents
./scripts/start-all-agents.sh

# Verify running in tmux with TTY
tmux list-sessions
tmux list-windows -t evox

# Check logs show no auth errors
tail -f logs/sam.log | grep -i "credit\|auth"

# Verify agents are picking up work
tail -f logs/sam.log | grep "TASK:"
```

## Related

- **AGT-258**: Original blocker issue (resolved by this ADR)
- **ADR-004**: Scheduler-driven agent activation (uses this tmux approach)
- `scripts/start-all-agents.sh`: Implementation
- `scripts/agent-loop.sh`: Agent execution loop (runs in tmux)
